<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ECALELF: Rereco production</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="page5">Rereco production </a></h1><h2><a class="anchor" id="RERECO">
RERECO</a></h2>
<p>The ReReco and the ntuple production can be run with the script ALCARAW_RECO/scripts/RerecoQuick.sh from the directory ALCARAW_RECO</p>
<h3><a class="anchor" id="RERECO_inputFiles">
Input files</a></h3>
<p>1. ALCARAW_RECO/config/reRecoTags/tag_name.py: is the file where the GT and the list of tags to be used for the rereco and the ntuple production have to be specified. "tag_name" is the name that will be automatically assigned to all the directories created for the rereco and the ntuples (the crab directory in ALCARAW_RECO/prod_alcarereco and the directories in eos with the reco files and the ntuples)</p>
<p>2. alcaraw_datasets.dat is the file with the list of the available alcaraw files</p>
<h3><a class="anchor" id="RERECO_outputFiles">
Output files</a></h3>
<p>1. alcarereco_datasets.dat is the file with the list of all the rerecos already done</p>
<p>2. ntuple_datasets.dat is the file with the list of all the ntuples already produced These two files are updated automatically with a line that summarizes all the relevant information about the rereco/ntuples (run range, dataset name, alcaraw name, storage_element, user_remote_dir_base, tag_name and, for ntuples, if they are produced from alcareco or alcarecosim and ...) when the script RerecoQuick.sh is launched</p>
<p>3. The rereco files produced are stored in /eos/cms/store/group/alca_ecalcalib/ecalelf/alcarereco/8TeV/tag_name</p>
<p>4. The final merged ntuple is stored in: /eos/cms/store/group/alca_ecalcalib/ecalelf/ntuples/8TeV/ALCARERECO/tag_name/</p>
<h3><a class="anchor" id="RERECO_instructions">
Instructions</a></h3>
<p>1. create the tag_name.py in ALCARAW_RECO/config/reRecoTags directory Se more detailes below, in section "TAG FILE"</p>
<p>2. commit the file in GITHUB: </p>
<div class="fragment"><pre class="fragment">git add config/reRecoTags/tag_name.py
git commit -m <span class="stringliteral">&quot;....&quot;</span> config/reRecoTags/tag_name.py
</pre></div><p>3. Add the period on which the ReReco has to be run in alcaraw_datasets.dat, if not already defined (e.g. RUN2012AB)</p>
<p>4. Run the script RerecoQuick.sh </p>
<div class="fragment"><pre class="fragment">   ./scripts/RerecoQuick.sh -p period -t config/reRecoTags/tag_name.py --json=jsonFile.txt --json_name={runMin}-{runMax}_{prompt,rereconame}_{jsonVersion} 
</pre></div><p> where:</p>
<ul>
<li>config/reRecoTags/tag_name.py is the configuration file defined in step1</li>
<li>jsonFile.txt is the version of the json file to be used</li>
<li>json_name is the name that ECALELF gives to the json file used for the ntuple production.</li>
</ul>
<ul>
<li>if you run this the system with ask you your PEM passphrase, which corresponds to the grid passphrase</li>
<li>if you don't have caf privilege add the option --scheduler=lsf at the end of the command <b> Not yet tested!!! </b></li>
</ul>
<h3><a class="anchor" id="lxplus6job">
Job submission on lxplus6</a></h3>
<p>Batch nodes at CERN are moving to slc6 and can be accessible only from lxplus6 machines. Consider to create the jobs on a lxplus5 machin with the previous command and adding the --createOnly option. Then move to an lxplus6 machine and re-execute the command but with the --submitOnly option instead.</p>
<ul>
<li>create the jobs on sl5 with option ./scripts/RerecoQuick.sh .... --createOnly</li>
<li>login on sls6</li>
<li>cd to the ...CMSSW_5_3_14_patch2/src/Calibration/</li>
<li>source initCmsEnv.csh</li>
<li>ignore the error messages</li>
<li>submit the jobs on sl6 with option ./scripts/RerecoQuick.sh .... --submitOnly</li>
</ul>
<p>Additional tricks with CERN batch system: if for any reason you want to migrate pending jobs from one queue to another you can run the command (bash syntax) </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">for</span> jobid in `bjobs -q cmscaf1nd | cut -d <span class="charliteral">&apos; &apos;</span> -f 1`; <span class="keywordflow">do</span> bmod -q 1nd $jobid; done
</pre></div><h3><a class="anchor" id="rerecoExample">
Rereco example:</a></h3>
<div class="fragment"><pre class="fragment">./scripts/RerecoQuick.sh -p RUN2012ABCD -t config/reRecoTags/Cal_Dic2013_ZeeIC_v1_mo_b.py --json=/afs/cern.ch/cms/CAF/CMSCOMM/COMM_DQM/certification/Collisions12/8TeV/Reprocessing/Cert_190456-208686_8TeV_22Jan2013ReReco_Collisions12_JSON.txt --json_name=190456-208686_22JanReReco_v1  --tutorial
</pre></div><p> The files alcarereco_datasets.dat and ntuple_datasets.dat ae updated when this script is launched</p>
<p>5. check the exit status of the jobs: </p>
<div class="fragment"><pre class="fragment">./scripts/RerecoQuick.sh  -p period -t config/reRecoTags/tag_name.py --json=jsonFile.txt --json_name={runMin}-{runMax}_{prompt,rereconame}_{jsonVersion} --check
</pre></div><p>This command will loop over all folders corresponding to the different datasets and check if jobs are exited with status 0 If jobs are finished, it merge all the produced ntuples and copy them to the right directory on EOS</p>
<p>6. if all went fine, commit the alcarereco_datasets.dat and ntuple_datasets.dat files </p>
<div class="fragment"><pre class="fragment">git pull --no-commit
</pre></div><p> this will try to merge your local repository with the central one. If there are no conflicts you just need to commit the changes, otherwise you should go throu the files in conflict, resolve them by hand and do </p>
<div class="fragment"><pre class="fragment"> git add file.cc 
</pre></div><p> to say that the confict on the file.cpp has been solved and now is staged for commit</p>
<p>And then you must: </p>
<div class="fragment"><pre class="fragment">git commit -m <span class="stringliteral">&quot;rereco tag_name done&quot;</span> alcarereco_datasets.dat ntuple_datasets.dat
</pre></div><h3><a class="anchor" id="RERECO_scriptOptions">
Script options</a></h3>
<p>--singleEle : to rereco also single electron datasets</p>
<h2><a class="anchor" id="TAGFILES">
TAG FILES</a></h2>
<p>To run the Rereco with a new set of conditions it is necessary to have a configuration file with the tags.</p>
<p>An example of a configuration file can be found in Calibration/ALCARAW_RECO/config/reRecoTags/test.py</p>
<p>Here an example: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">##############################################################</span>
<span class="preprocessor"></span><span class="keyword">import</span> FWCore.ParameterSet.Config as cms
from CondCore.DBCommon.CondDBSetup_cfi <span class="keyword">import</span> *

<span class="preprocessor">#### Please fill with comments</span>
<span class="preprocessor"></span><span class="preprocessor"># Basic tag combination for 2012 end year seminar conditions</span>
<span class="preprocessor"></span><span class="preprocessor"># Laser, alpha tags are fixed: no time to improve them</span>
<span class="preprocessor"></span><span class="preprocessor"># A set of IC are derived on top of them and will be tested:</span>
<span class="preprocessor"></span><span class="preprocessor"># Cal_Nov2012_ICEle_v2:</span>
<span class="preprocessor"></span><span class="preprocessor"># description</span>
<span class="preprocessor"></span><span class="preprocessor">#</span>
<span class="preprocessor"></span>
RerecoGlobalTag = cms.ESSource(<span class="stringliteral">&quot;PoolDBESSource&quot;</span>,
                               CondDBSetup,
                               connect = cms.string(<span class="stringliteral">&apos;frontier://FrontierProd/CMS_COND_31X_GLOBALTAG&apos;</span>),
                               globaltag = cms.string(<span class="stringliteral">&apos;GR_R_53_V13::All&apos;</span>),
                               toGet = cms.VPSet(
    cms.PSet(record = cms.string(<span class="stringliteral">&quot;EcalLaserAPDPNRatiosRcd&quot;</span>),
             tag = cms.string(<span class="stringliteral">&apos;EcalLaserAPDPNRatios_data_20120814_2011-2012_v3_upd20120919&apos;</span>),
             connect = cms.untracked.string(<span class="stringliteral">&quot;frontier://FrontierProd/CMS_COND_42X_ECAL_LAS&quot;</span>)
             )
    ,cms.PSet(record = cms.string(<span class="stringliteral">&apos;EcalLaserAlphasRcd&apos;</span>),
              tag = cms.string(<span class="stringliteral">&apos;EcalLaserAlphas_EB_sic1_btcp152_EE_sic1_btcp116&apos;</span>),
              connect = cms.untracked.string(<span class="stringliteral">&apos;frontier://FrontierInt/CMS_COND_ECAL&apos;</span>)
              )
    ,cms.PSet(record = cms.string(<span class="stringliteral">&quot;EcalIntercalibConstantsRcd&quot;</span>),
              tag = cms.string(<span class="stringliteral">&apos;EcalIntercalibConstants_V20120922_Ele19092012_2012IncEtaScale8TeV&apos;</span>),
              connect = cms.untracked.string(<span class="stringliteral">&quot;frontier://FrontierInt/CMS_COND_ECAL&quot;</span>)
              )
    ),
                               BlobStreamerName = cms.untracked.string(<span class="stringliteral">&apos;TBufferBlobStreamingService&apos;</span>)
                               )

#############################################################
</pre></div><p>The convention is to name these configuration files in this way: tag_name.py</p>
<p>So, for the rereco production follow the steps below: </p>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 24 Jun 2014 for ECALELF by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
